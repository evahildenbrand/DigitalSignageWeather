<!DOCTYPE html PUBLIC "https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Wetter</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" href="rain.css" />
  </head>

  <body onload="updateBackground();">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="./Data.js"></script>

    <script>
      //Stündliche aktualisierung der Daten
      $(document).ready(function() {
        setInterval(function() {
          reload_page();

          // alert("It worked");
        }, 60 * 60000); //1 Stunde
      });

      function reload_page() {
        window.location.reload(true);
      }

      let url = "http://www.zamg.ac.at/ogd/";
      let rain;

      const pageWidth = window.innerWidth;
      const pageHeight = window.innerHeight;
      const defaultDropNum = 100;

      /* const data = new Data();
        let dataArray = data.getData();
        console.log(dataArray);*/

      $.ajax({
        type: "GET",
        url: "http://www.zamg.ac.at/ogd/",
        dataType: "text",
        success: function(csv) {
          let lines = csv.split(/\r?\n|\r/);
          let index = 1;
          let currentLine = lines[index].split(";");

          let outputTempIndex = 5;
          document.getElementById("outputTemp").innerHTML =
            currentLine[outputTempIndex] + " °C";
          let outputWindSpeedIndex = 9;
          document.getElementById("outputWindSpeed").innerHTML =
            currentLine[outputWindSpeedIndex] + "  km/h";
          let outputRainFallIndex = 12;
          document.getElementById("outputRainFall").innerHTML =
            currentLine[outputRainFallIndex] + "  l/m²";

          rain = currentLine[outputRainFallIndex];

          if (rain > "0") {
            updateBackground();
          }
        }
      });

      //Hintergrundfarbe je nach Zeit ändern
      function updateBackground() {
        //Einlesen der Variablen
        var hr = new Date().getHours(); //Aktuelle Stunde herausfinden
        var body = document.body;
        var bstyle = body.style;

        if(rain > "0"){
          bstyle.backgroundImage = "url('./images/bgRain.jpg')";
          makeItRain(defaultDropNum);
        }else{
          //Zwischen 19 und 21 Uhr bzw. 5 und 7 Uhr blauer Hintergrund
          if ((hr >= 19 && hr < 21) || (hr >= 5 && hr < 7)) {
            bstyle.backgroundColor = "#0059b3";
            bstyle.color = "black";
            bstyle.backgroundImage = "url('./images/bgTwilight.jpg')";
            //Zwischen 21 und 5 Uhr dunkelblauer Hintergrund
          } else if (hr >= 21 || hr < 5) {
            bstyle.backgroundColor = "#000066";
            bstyle.color = "white";
            bstyle.backgroundImage = "url('./images/bgNight.jpg')";
            //Zwischen 7 und 19 Uhr hellblauer Hintergrund
          } else if (hr >= 7 && hr < 19) {
            bstyle.backgroundColor = "#ccefff";
            bstyle.color = "black";
            bstyle.backgroundImage = "url('./images/bgDay.jpg')";
            //Sonst weißer Hintergrund
          } else {
            bstyle.backgroundColor = "white";
            bstyle.color = "black";
          }
        }
      }
        
      //Jede Minute die Funktion updateBackground aufrufen
      setInterval(updateBackground, 1000 * 60);

      //Jede Minute die Funktion updateImage aufrufen
      /*setInterval(updateImage, 1000 * 60);

      //Mond bzw. Sonne je nach Zeit ändern
      function updateImage() {
        //Einlesen der Variablen
        var hr = new Date().getHours(); //Aktuelle Stunde ermitteln
        var page = document.getElementById("fullpage");

        //Zwischen 21 und 5 Uhr Mond anzeigen
        if (hr >= 21 || hr <= 5) {
          page.classList.add("night");
          //Ansonsten Sonne anzeigen
        } else {
          page.classList.remove("night");
        }
        if (hr >= 10 || hr <= 13) {
          document.getElementById("sun").style.marginTop = "-30%";
          document.getElementById("circle").style.background =
            "linear-gradient(to bottom, #69DEF5, #5EC6DB)";
        }

        //Wenn es regnet ...
        if (rain > "0") {
          //grauer Kreis
          document.getElementById("circle").style.background = "#cccccc";
          //keine Sonne
          document.getElementById("sun").style.background = "#cccccc";
          //Sonne nicht im Wasser spiegeln
          document.getElementById("water").style.background =
            "radial-gradient(ellipse farthest-corner at center -400%,#cccccc 30%,#518eac 90%)";
          //keinen Mond
          page.classList.remove("night");

          //Regen anzeigen
          makeItRain(defaultDropNum);
          //... sonst
        } else {
          document.getElementById("circle").style.background =
            "linear-gradient(to bottom, #be4405, #f6c60c)";
          document.getElementById("sun").style.background = "#f2ef88";
          document.getElementById("water").style.background =
            "radial-gradient(ellipse farthest-corner at center -400%,#f5c30e 30%,#518eac 90%)";
        }

      }*/

      //Funktion für den Regen
      function makeItRain(num) {
          let elements = document.getElementById("drops-section");

          while (elements.hasChildNodes()) {
            elements.removeChild(elements.lastChild);
          }
          for (let i = 0; i < num; i++) {
            let randomX = Math.floor(Math.random() * pageWidth);
            let randomY = Math.floor(Math.random() * pageHeight);
            let dropSpeed = Math.floor(Math.random() * (25 - 5)) + 5;
            let dropWidth =
              Math.floor(Math.random() * (dropSpeed / 10 - 1)) + 1;
            let dropHeight =
              Math.floor(Math.random() * (dropSpeed * 2 - 3)) + 3;
            let d = new Drop(
              randomX,
              randomY,
              dropSpeed,
              dropWidth,
              dropHeight
            );

            d.show();
            d.fall();
          }
        }
    </script>

    <div id="weatherContainer">
      <p id="location">
        Leonding <br>
        <span>Heute</span>
      </p>
      <div id="tempContainer">
        <img id="imgTemp" src="./icons/thermometer.png" />
        <p id="outputTemp"></p>
      </div><br>
      <div id="windContainer">
        <img id="imgWind" src="./icons/wind.png" />
        <p id="outputWindSpeed"></p>
      </div><br>
      <div id="rainFallContainer">
        <img id="imgRain" src="./icons/cloud-with-raindrops.png" />
        <p id="outputRainFall"></p>
      </div>
    </div>

    <div id="drops-section"></div>

    <!--Klasse für die Regentropfen einbinden-->
    <script src="Drop.js"></script>
  </body>
</html>
