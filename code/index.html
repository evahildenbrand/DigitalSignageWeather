<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Wetter</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./rainyday.min.js"></script>
  </head>

  <body>
    <script>
      //Stündliche aktualisierung der Daten
      $(document).ready(function() {
        setInterval(function() {
          reload_page();
          // alert("It worked");
        }, 60 * 60000); //1 Stunde
      });

      function reload_page() {
        window.location.reload(true);
      }

      let url = "http://www.zamg.ac.at/ogd/";
      let rain;

      Promise.all(
        ["tawes1h.csv", "http://www.zamg.ac.at/ogd/"].map(function(url) {
          return fetch(url)
            .then(function(response) {
              return response.ok
                ? response.text()
                : Promise.reject(response.status);
            })
            .then(function(text) {
              //Einlesen der Variablen
              let index = 1;
              let tempIndex = 5;
              let windSpeedIndex = 9;
              let rainFallIndex = 12;

              //Teilt die einzelnen Lines in ein Array
              let lines = text.split(/\r?\n|\r/);

              //macht aus der 1 Zeile (Wetter Hörsching) einen Array
              let currentline = lines[index].split(";");

              //Ausgabe der Elemente
              document.getElementById("outputTemp").innerHTML =
                currentline[tempIndex] + " °C";
              document.getElementById("outputWindSpeed").innerHTML =
                currentline[windSpeedIndex] + " km/h";
              document.getElementById("outputRainFall").innerHTML =
                currentline[rainFallIndex] + " L/m²";

              rain = currentline[rainFallIndex];

              if (rain > "0") {
                updateImage();
              }
            });
        })
      );

      //Hintergrundfarbe je nach Zeit ändern
      function updateBackground() {
        //Einlesen der Variablen
        var hr = new Date().getHours(); //Aktuelle Stunde herausfinden
        var body = document.body;
        var bstyle = body.style;

        //Zwischen 19 und 21 Uhr bzw. 5 und 7 Uhr blauer Hintergrund
        if ((hr >= 19 && hr < 21) || (hr >= 5 && hr < 7)) {
          bstyle.backgroundColor = "#0059b3";
          bstyle.color = "black";
          //Zwischen 21 und 5 Uhr dunkelblauer Hintergrund
        } else if (hr >= 21 || hr < 5) {
          bstyle.backgroundColor = "#000066";
          bstyle.color = "white";
          //Zwischen 7 und 19 Uhr hellblauer Hintergrund
        } else if (hr >= 7 && hr < 19) {
          bstyle.backgroundColor = "#ccefff";
          bstyle.color = "black";
          updateImage();
          //Sonst weißer Hintergrund
        } else {
          bstyle.backgroundColor = "white";
          bstyle.color = "black";
        }
      }
      //Jede Minute die Funktion updateBackground aufrufen
      setInterval(updateBackground, 1000 * 60);
      updateBackground();

      //Jede Minute die Funktion updateImage aufrufen
      setInterval(updateImage, 1000 * 60);

      //Mond bzw. Sonne je nach Zeit ändern
      function updateImage() {
        //Einlesen der Variablen
        var hr = new Date().getHours(); //Aktuelle Stunde ermitteln
        var page = document.getElementById("fullpage");

        //Zwischen 21 und 5 Uhr Mond anzeigen
        if (hr >= 21 || hr <= 5) {
          page.classList.add("night");
          //Ansonsten Sonne anzeigen
        } else {
          page.classList.remove("night");
        }

        if (rain > "0") {
          /*var image = document.getElementById("background");
          image.onload = function() {
            var engine = new RainyDay({
              image: this
            });
            engine.rain([[3, 2, 2]], 100);
          };
          image.crossOrigin = "anonymous";
          image.src = "http://i.imgur.com/U1Tqqdw.jpg";*/

          document.getElementById('circle').style.background = '#cccccc';
          document.getElementById('sun').style.background = '#cccccc';
        }else{
          document.getElementById('circle').style.background = '#';
          document.getElementById('sun').style.background = '#f2ef88';
        }
      }
    </script>
<!--<img id='background' src="">-->

    <div id="fullpage">
      <div class="section">
        <div id="circle">
          <p id="outputTemp"></p>
          <p id="outputWindSpeed"></p>
          <p id="outputRainFall"></p>
          <div id="sun"></div>
          <div class="moon">
            <div></div>
            <div></div>
            <div></div>
          </div>
          <div class="stars">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
          <div class="water"></div>
        </div>
      </div>
    </div>
  </body>
</html>
